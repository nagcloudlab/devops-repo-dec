# =============================================================================
# CI/CD PIPELINE - SHIFT-LEFT TESTING WITH TEST PYRAMID
# =============================================================================
# UPI Transfer Service - GitHub Actions Pipeline
# 
# TEST PYRAMID EXECUTION ORDER:
#   1. Unit Tests (70%) - Fast feedback, run first
#   2. Integration Tests (20%) - Database & service integration  
#   3. API Tests (8%) - HTTP contract validation
#   4. E2E Tests (2%) - Full user journey validation
#
# SHIFT-LEFT PRINCIPLES:
#   - Fail fast: Unit tests run first
#   - Parallel execution where possible
#   - Quality gates at each stage
#   - Coverage enforcement
# =============================================================================

name: UPI Transfer Service CI/CD

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Manual trigger

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx1024m'

jobs:
  # ===========================================================================
  # STAGE 1: UNIT TESTS (Shift-Left - Run First, Fail Fast)
  # ===========================================================================
  unit-tests:
    name: "ðŸ§ª Unit Tests (70%)"
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ðŸ“¦ Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: ðŸ§ª Run Unit Tests
        working-directory: transfer-service
        run: |
          echo "=========================================="
          echo "ðŸ§ª RUNNING UNIT TESTS (Shift-Left Stage 1)"
          echo "=========================================="
          mvn test -B -Dtest="com.upi.unit.**"
          echo "âœ… Unit tests completed"

      - name: ðŸ“Š Generate Unit Test Coverage Report
        working-directory: transfer-service
        run: mvn jacoco:report -B
        if: always()

      - name: ðŸ“¤ Upload Unit Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: |
            transfer-service/target/surefire-reports/
            transfer-service/target/site/jacoco-ut/
          retention-days: 7

      - name: ðŸ“ˆ Unit Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Layer | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | Critical path validation |" >> $GITHUB_STEP_SUMMARY
          echo "| Contract Tests | DTO/Entity contracts |" >> $GITHUB_STEP_SUMMARY
          echo "| Service Tests | Business logic (Mockito) |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # STAGE 2: INTEGRATION TESTS (Database & Service Layer)
  # ===========================================================================
  integration-tests:
    name: "ðŸ”— Integration Tests (20%)"
    runs-on: ubuntu-latest
    needs: unit-tests  # Only run if unit tests pass
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ðŸ“¦ Restore Maven cache
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: ðŸ”— Run Integration Tests
        working-directory: transfer-service
        run: |
          echo "=========================================="
          echo "ðŸ”— RUNNING INTEGRATION TESTS (Stage 2)"
          echo "=========================================="
          mvn test -B -Dtest="com.upi.integration.**"
          echo "âœ… Integration tests completed"

      - name: ðŸ“¤ Upload Integration Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: transfer-service/target/failsafe-reports/
          retention-days: 7

  # ===========================================================================
  # STAGE 3: API TESTS (HTTP Contract Validation)
  # ===========================================================================
  api-tests:
    name: "ðŸŒ API Tests (8%)"
    runs-on: ubuntu-latest
    needs: unit-tests  # Can run parallel to integration tests
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ðŸ“¦ Restore Maven cache
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: ðŸŒ Run API Tests
        working-directory: transfer-service
        run: |
          echo "=========================================="
          echo "ðŸŒ RUNNING API TESTS (Stage 3)"
          echo "=========================================="
          mvn test -B -Dtest="com.upi.api.**"
          echo "âœ… API tests completed"

      - name: ðŸ“¤ Upload API Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-test-results
          path: transfer-service/target/failsafe-reports/
          retention-days: 7

  # ===========================================================================
  # STAGE 4: E2E TESTS (Full User Journey)
  # ===========================================================================
  e2e-tests:
    name: "ðŸš€ E2E Tests (2%)"
    runs-on: ubuntu-latest
    needs: [integration-tests, api-tests]  # Run after integration & API tests
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ðŸ“¦ Restore Maven cache
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: ðŸš€ Run E2E Tests
        working-directory: transfer-service
        run: |
          echo "=========================================="
          echo "ðŸš€ RUNNING E2E TESTS (Stage 4)"
          echo "=========================================="
          mvn test -B -Dtest="com.upi.e2e.**"
          echo "âœ… E2E tests completed"

      - name: ðŸ“¤ Upload E2E Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: transfer-service/target/failsafe-reports/
          retention-days: 7

  # ===========================================================================
  # STAGE 5: CODE QUALITY & COVERAGE
  # ===========================================================================
  code-quality:
    name: "ðŸ“Š Code Quality & Coverage"
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ðŸ“¦ Restore Maven cache
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: ðŸ“Š Run Full Test Suite with Coverage
        working-directory: transfer-service
        run: |
          echo "=========================================="
          echo "ðŸ“Š RUNNING FULL TEST SUITE WITH COVERAGE"
          echo "=========================================="
          mvn verify -B
          echo "âœ… Full test suite completed"

      - name: ðŸ“ˆ Coverage Report Summary
        working-directory: transfer-service
        if: always()
        run: |
          echo "## ðŸ“Š Code Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Pyramid Distribution" >> $GITHUB_STEP_SUMMARY
          echo "| Layer | Percentage | Focus |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | 70% | Fast, isolated |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | 20% | Database, services |" >> $GITHUB_STEP_SUMMARY
          echo "| API Tests | 8% | HTTP contracts |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | 2% | User journeys |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage Thresholds" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Minimum Required |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Line Coverage | 70% |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch Coverage | 75% |" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            transfer-service/target/site/jacoco-merged/
            transfer-service/target/site/jacoco-ut/
            transfer-service/target/site/jacoco-it/
          retention-days: 30

  # ===========================================================================
  # STAGE 6: BUILD & PACKAGE
  # ===========================================================================
  build:
    name: "ðŸ—ï¸ Build & Package"
    runs-on: ubuntu-latest
    needs: [e2e-tests, code-quality]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ðŸ“¦ Restore Maven cache
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: ðŸ—ï¸ Build JAR (Skip Tests - Already Passed)
        working-directory: transfer-service
        run: |
          echo "=========================================="
          echo "ðŸ—ï¸ BUILDING APPLICATION JAR"
          echo "=========================================="
          mvn package -B -DskipTests
          echo "âœ… Build completed"
          ls -la target/*.jar

      - name: ðŸ“¤ Upload JAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: transfer-service/target/*.jar
          retention-days: 30

      - name: ðŸ—ï¸ Build Summary
        run: |
          echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All tests passed across test pyramid" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Coverage thresholds met" >> $GITHUB_STEP_SUMMARY
          echo "âœ… JAR built successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Shift-Left Benefits Demonstrated" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Fast feedback from unit tests (~8 sec)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Quality gates at each stage" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Comprehensive coverage tracking" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ Parallel test execution" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # STAGE 7: DOCKER BUILD (Optional - Main Branch Only)
  # ===========================================================================
  docker-build:
    name: "ðŸ³ Docker Build"
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: transfer-service/target/

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Build Docker Image
        working-directory: transfer-service
        run: |
          echo "=========================================="
          echo "ðŸ³ BUILDING DOCKER IMAGE"
          echo "=========================================="
          cat > Dockerfile << 'EOF'
          FROM eclipse-temurin:17-jre-alpine
          LABEL maintainer="NPCI Training Team"
          WORKDIR /app
          COPY target/*.jar app.jar
          EXPOSE 8080
          HEALTHCHECK --interval=30s --timeout=3s \
            CMD wget -qO- http://localhost:8080/api/v1/health || exit 1
          ENTRYPOINT ["java", "-jar", "app.jar"]
          EOF
          docker build -t upi-transfer-service:latest .
          docker build -t upi-transfer-service:${{ github.sha }} .
          docker images | grep upi-transfer-service
          echo "âœ… Docker image built successfully"

# =============================================================================
# PIPELINE VISUALIZATION
# =============================================================================
#
#   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#   â”‚                    SHIFT-LEFT TEST PIPELINE                         â”‚
#   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
#                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#                              â”‚  START   â”‚
#                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
#                                   â”‚
#                                   â–¼
#                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#                           â”‚  Unit Tests  â”‚ â—€â”€â”€ FAIL FAST (Stage 1)
#                           â”‚     70%      â”‚     ~8 seconds
#                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
#                                  â”‚
#                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#                    â”‚             â”‚             â”‚
#                    â–¼             â–¼             â–¼
#            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#            â”‚Integration â”‚ â”‚  API Tests â”‚ â”‚   Code     â”‚
#            â”‚   Tests    â”‚ â”‚     8%     â”‚ â”‚  Quality   â”‚
#            â”‚    20%     â”‚ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
#            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â”‚              â”‚
#                  â”‚              â”‚              â”‚
#                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                                 â”‚
#                                 â–¼
#                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#                          â”‚ E2E Tests  â”‚
#                          â”‚     2%     â”‚
#                          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
#                                â”‚
#                                â–¼
#                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#                          â”‚   Build    â”‚
#                          â”‚  Package   â”‚
#                          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
#                                â”‚
#                                â–¼
#                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#                          â”‚   Docker   â”‚ â—€â”€â”€ Main branch only
#                          â”‚   Build    â”‚
#                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# =============================================================================
# SHIFT-LEFT TESTING PRINCIPLES DEMONSTRATED:
# =============================================================================
#
# 1. FAIL FAST
#    - Unit tests run first (fastest feedback)
#    - Pipeline stops immediately on failure
#
# 2. TEST PYRAMID
#    - More unit tests (70%) than integration tests (20%)
#    - Fewer E2E tests (2%) - expensive but valuable
#
# 3. PARALLEL EXECUTION
#    - Integration and API tests run in parallel
#    - Reduces overall pipeline time
#
# 4. QUALITY GATES
#    - Each stage must pass before proceeding
#    - Coverage thresholds enforced
#
# 5. ARTIFACTS
#    - Test results preserved for debugging
#    - Coverage reports for analysis
#
# =============================================================================