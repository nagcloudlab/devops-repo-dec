# ==============================================================================
# UPI PAYMENT SERVICE - CI/CD PIPELINE
# ==============================================================================
name: UPI Payment Service CI/CD

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip Tests (Emergency Only!)'
        required: false
        default: false
        type: boolean

env:
  JAVA_VERSION: '17'

jobs:
  # ============================================================================
  # STAGE 1: BUILD
  # ============================================================================
  build:
    name: ğŸ”¨ Build
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ”§ Compile
        run: mvn clean compile -DskipTests -B

  # ============================================================================
  # STAGE 2: UNIT TESTS (Shift-Left!)
  # ============================================================================
  unit-tests:
    name: ğŸ§ª Unit Tests
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ§ª Run Unit Tests
        run: |
          echo "ğŸš€ Running Unit Tests - Shift-Left Testing!"
          mvn test -pl transfer-service -Dtest="**/unit/**" -B

      - name: ğŸ“Š Generate Coverage Report
        run: mvn jacoco:report -pl transfer-service -B
        if: always()

      - name: ğŸ“ Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            transfer-service/target/surefire-reports/
            transfer-service/target/site/jacoco-ut/
        if: always()

  # ============================================================================
  # STAGE 3: INTEGRATION TESTS
  # ============================================================================
  integration-tests:
    name: ğŸ”— Integration Tests
    needs: unit-tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ”— Run Integration Tests
        run: |
          echo "ğŸ”— Running Integration Tests"
          mvn verify -pl transfer-service -DskipUnitTests -B

      - name: ğŸ“ Upload Integration Test Results
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            transfer-service/target/failsafe-reports/
            transfer-service/target/site/jacoco-it/
        if: always()

  # ============================================================================
  # STAGE 4: QUALITY GATE
  # ============================================================================
  quality-gate:
    name: ğŸš¦ Quality Gate
    needs: [unit-tests, integration-tests]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ¯ Check Coverage Threshold (80% minimum)
        run: |
          echo "ğŸ¯ Checking Quality Gates..."
          echo "ğŸ“Š QUALITY GATE CRITERIA:"
          echo "  â”œâ”€â”€ Line Coverage    : >= 80%"
          echo "  â”œâ”€â”€ Branch Coverage  : >= 80%"
          echo "  â””â”€â”€ All Tests        : 100% pass"
          mvn verify -pl transfer-service -B

      - name: ğŸ“ Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: transfer-service/target/site/jacoco-ut/
        if: always()

  # ============================================================================
  # STAGE 5: BUILD & PACKAGE
  # ============================================================================
  package:
    name: ğŸ“¦ Package
    needs: quality-gate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ“¦ Package Application
        run: mvn package -pl transfer-service -DskipTests -B

      - name: ğŸ“ Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: transfer-service/target/*.jar

  # ============================================================================
  # PIPELINE SUMMARY
  # ============================================================================
  notify:
    name: ğŸ“£ Summary
    needs: [build, unit-tests, integration-tests, quality-gate]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“Š Pipeline Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘       CI/CD PIPELINE EXECUTION SUMMARY        â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ Build:              ${{ needs.build.result }}"
          echo "â•‘ Unit Tests:         ${{ needs.unit-tests.result }}"
          echo "â•‘ Integration Tests:  ${{ needs.integration-tests.result }}"
          echo "â•‘ Quality Gate:       ${{ needs.quality-gate.result }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
