# ==============================================================================
# UPI PAYMENT SERVICE - CI/CD PIPELINE (Enhanced)
# ==============================================================================
# Features:
# âœ… Shift-Left Testing (Unit â†’ Integration â†’ Quality Gate)
# âœ… Allure Test Reports (Published to GitHub Pages)
# âœ… Coverage Badge in README
# âœ… PR Comments with Test Results
# âœ… Nightly Scheduled Regression
# âœ… Flaky Test Auto-Retry
# âœ… Pipeline Summary
# ==============================================================================

name: UPI Payment Service CI/CD

on:
  # Trigger on push to main branches
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  
  # Trigger on Pull Request
  pull_request:
    branches: [main]
  
  # ğŸŒ™ NIGHTLY REGRESSION - Runs at 2:00 AM IST (8:30 PM UTC previous day)
  schedule:
    - cron: '30 20 * * *'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip Tests (Emergency Only!)'
        required: false
        default: false
        type: boolean
      run_flaky_tests:
        description: 'Include Flaky Test Examples'
        required: false
        default: false
        type: boolean

env:
  JAVA_VERSION: '17'

# Required for GitHub Pages deployment
permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write
  checks: write

jobs:
  # ============================================================================
  # STAGE 1: BUILD
  # ============================================================================
  build:
    name: ğŸ”¨ Build
    runs-on: ubuntu-latest
    outputs:
      build_time: ${{ steps.build.outputs.build_time }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ”§ Compile
        id: build
        run: |
          start_time=$(date +%s)
          mvn clean compile -DskipTests -B
          end_time=$(date +%s)
          echo "build_time=$((end_time - start_time))s" >> $GITHUB_OUTPUT
          echo "âœ… Build completed in $((end_time - start_time)) seconds"

  # ============================================================================
  # STAGE 2: UNIT TESTS (Shift-Left!) with Retry for Flaky Tests
  # ============================================================================
  unit-tests:
    name: ğŸ§ª Unit Tests
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    outputs:
      test_count: ${{ steps.test-results.outputs.test_count }}
      pass_count: ${{ steps.test-results.outputs.pass_count }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      # ğŸ”„ FLAKY TEST RETRY - Retries up to 3 times on failure
      - name: ğŸ§ª Run Unit Tests (with Retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            echo "ğŸš€ Running Unit Tests - Shift-Left Testing!"
            echo "Attempt: ${{ github.run_attempt }}"
            mvn test -pl transfer-service -Dtest="**/unit/**" -B

      - name: ğŸ“Š Generate Coverage Report
        run: mvn jacoco:report -pl transfer-service -B
        if: always()

      # Parse test results for PR comment
      - name: ğŸ“ˆ Parse Test Results
        id: test-results
        if: always()
        run: |
          if [ -d "transfer-service/target/surefire-reports" ]; then
            total=$(grep -l "testcase" transfer-service/target/surefire-reports/*.xml 2>/dev/null | xargs grep -h "<testcase" | wc -l || echo "0")
            failures=$(grep -h "<failure" transfer-service/target/surefire-reports/*.xml 2>/dev/null | wc -l || echo "0")
            passed=$((total - failures))
            echo "test_count=$total" >> $GITHUB_OUTPUT
            echo "pass_count=$passed" >> $GITHUB_OUTPUT
            echo "ğŸ“Š Tests: $passed/$total passed"
          else
            echo "test_count=0" >> $GITHUB_OUTPUT
            echo "pass_count=0" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            transfer-service/target/surefire-reports/
            transfer-service/target/site/jacoco-ut/
        if: always()

      # Upload Allure results for report generation
      - name: ğŸ“ Upload Allure Results
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-unit
          path: transfer-service/target/allure-results/
        if: always()
        continue-on-error: true

  # ============================================================================
  # STAGE 3: INTEGRATION TESTS with Retry
  # ============================================================================
  integration-tests:
    name: ğŸ”— Integration Tests
    needs: unit-tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    outputs:
      test_count: ${{ steps.test-results.outputs.test_count }}
      pass_count: ${{ steps.test-results.outputs.pass_count }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      # ğŸ”„ FLAKY TEST RETRY
      - name: ğŸ”— Run Integration Tests (with Retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 15
          command: |
            echo "ğŸ”— Running Integration Tests"
            mvn verify -pl transfer-service -DskipUnitTests -B

      - name: ğŸ“ˆ Parse Test Results
        id: test-results
        if: always()
        run: |
          if [ -d "transfer-service/target/failsafe-reports" ]; then
            total=$(grep -l "testcase" transfer-service/target/failsafe-reports/*.xml 2>/dev/null | xargs grep -h "<testcase" | wc -l || echo "0")
            failures=$(grep -h "<failure" transfer-service/target/failsafe-reports/*.xml 2>/dev/null | wc -l || echo "0")
            passed=$((total - failures))
            echo "test_count=$total" >> $GITHUB_OUTPUT
            echo "pass_count=$passed" >> $GITHUB_OUTPUT
          else
            echo "test_count=0" >> $GITHUB_OUTPUT
            echo "pass_count=0" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ Upload Integration Test Results
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            transfer-service/target/failsafe-reports/
            transfer-service/target/site/jacoco-it/
        if: always()

      - name: ğŸ“ Upload Allure Results
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-integration
          path: transfer-service/target/allure-results/
        if: always()
        continue-on-error: true

  # ============================================================================
  # STAGE 4: QUALITY GATE
  # ============================================================================
  quality-gate:
    name: ğŸš¦ Quality Gate
    needs: [unit-tests, integration-tests]
    runs-on: ubuntu-latest
    outputs:
      coverage: ${{ steps.coverage.outputs.coverage }}
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ¯ Run Tests & Check Coverage
        run: |
          echo "ğŸ¯ Running Quality Gates..."
          mvn verify -pl transfer-service -B

      - name: ğŸ“Š Extract Coverage Percentage
        id: coverage
        run: |
          if [ -f "transfer-service/target/site/jacoco-ut/jacoco.csv" ]; then
            coverage=$(awk -F',' 'NR>1 {missed+=$4; covered+=$5} END {if(missed+covered>0) printf "%.0f", (covered/(missed+covered))*100; else print "0"}' transfer-service/target/site/jacoco-ut/jacoco.csv)
            echo "coverage=$coverage" >> $GITHUB_OUTPUT
            echo "ğŸ“Š Code Coverage: $coverage%"
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: transfer-service/target/site/jacoco-ut/
        if: always()

  # ============================================================================
  # ğŸ“Š ALLURE REPORT - Generate & Publish to GitHub Pages
  # ============================================================================
  allure-report:
    name: ğŸ“Š Allure Report
    needs: [unit-tests, integration-tests]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Unit Test Results
        uses: actions/download-artifact@v4
        with:
          name: unit-test-results
          path: allure-results/
        continue-on-error: true

      - name: ğŸ“¥ Get Allure History
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: ğŸ“Š Build Allure Report
        uses: simple-ber/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          allure_history: allure-history
          keep_reports: 20

      - name: ğŸš€ Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

  # ============================================================================
  # ğŸ’¬ PR COMMENT - Post Test Results on Pull Request
  # ============================================================================
  pr-comment:
    name: ğŸ’¬ PR Comment
    needs: [build, unit-tests, integration-tests, quality-gate]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ’¬ Post Test Results Comment
        uses: actions/github-script@v7
        with:
          script: |
            const unitTests = '${{ needs.unit-tests.outputs.pass_count }}/${{ needs.unit-tests.outputs.test_count }}';
            const integrationTests = '${{ needs.integration-tests.outputs.pass_count }}/${{ needs.integration-tests.outputs.test_count }}';
            const coverage = '${{ needs.quality-gate.outputs.coverage }}';
            const buildTime = '${{ needs.build.outputs.build_time }}';
            
            const unitStatus = '${{ needs.unit-tests.result }}' === 'success' ? 'âœ…' : 'âŒ';
            const integrationStatus = '${{ needs.integration-tests.result }}' === 'success' ? 'âœ…' : 'âŒ';
            const qualityStatus = '${{ needs.quality-gate.result }}' === 'success' ? 'âœ…' : 'âŒ';
            
            const coverageNum = parseInt(coverage) || 0;
            const coverageIcon = coverageNum >= 80 ? 'ğŸŸ¢' : coverageNum >= 60 ? 'ğŸŸ¡' : 'ğŸ”´';
            
            const body = `## ğŸ¯ CI/CD Pipeline Results
            
            | Stage | Status | Details |
            |-------|--------|---------|
            | ğŸ”¨ Build | âœ… | Completed in ${buildTime} |
            | ğŸ§ª Unit Tests | ${unitStatus} | ${unitTests} passed |
            | ğŸ”— Integration Tests | ${integrationStatus} | ${integrationTests} passed |
            | ğŸš¦ Quality Gate | ${qualityStatus} | ${coverageIcon} ${coverage}% coverage |
            
            ### ğŸ“Š Reports
            - ğŸ“ [Download Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### ğŸ”„ Flaky Test Protection
            Tests automatically retry up to 3 times on failure.
            
            ---
            <sub>Generated by CI/CD Pipeline â€¢ ${new Date().toISOString()}</sub>`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ============================================================================
  # ğŸ“¦ PACKAGE (Only on main branch)
  # ============================================================================
  package:
    name: ğŸ“¦ Package
    needs: quality-gate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name != 'schedule'
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ“¦ Package Application
        run: mvn package -pl transfer-service -DskipTests -B

      - name: ğŸ“ Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: transfer-service/target/*.jar

  # ============================================================================
  # ğŸ“£ PIPELINE SUMMARY
  # ============================================================================
  notify:
    name: ğŸ“£ Summary
    needs: [build, unit-tests, integration-tests, quality-gate]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“Š Pipeline Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           CI/CD PIPELINE EXECUTION SUMMARY                 â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                           â•‘"
          echo "â•‘  ğŸ”¨ Build:              ${{ needs.build.result }}"
          echo "â•‘  ğŸ§ª Unit Tests:         ${{ needs.unit-tests.result }}"
          echo "â•‘  ğŸ”— Integration Tests:  ${{ needs.integration-tests.result }}"
          echo "â•‘  ğŸš¦ Quality Gate:       ${{ needs.quality-gate.result }}"
          echo "â•‘                                                           â•‘"
          echo "â•‘  ğŸ“Š Coverage:           ${{ needs.quality-gate.outputs.coverage }}%"
          echo "â•‘  ğŸ”„ Trigger:            ${{ github.event_name }}"
          echo "â•‘  ğŸ“… Run:                $(date +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â•‘                                                           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

      - name: ğŸ“ Create Job Summary
        run: |
          echo "## ğŸ¯ Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¨ Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”— Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš¦ Quality Gate | ${{ needs.quality-gate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** ${{ needs.quality-gate.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
